{% extends 'base.html' %}
{% block title %}Verify Phone | Jodise{% endblock %}

{% block content %}
<div class="max-w-md mx-auto bg-white rounded-2xl shadow-md p-6 mt-10">

    {% if phone %}
    <!-- STATE 1: PHONE EXISTS (VERIFY OTP) -->
    <h2 class="text-2xl font-bold text-center mb-4 text-indigo-600">Verify Your Phone</h2>
    <p class="text-gray-600 text-center mb-6">
        Weâ€™ve sent a 6-digit OTP to <strong>{{ phone }}</strong>
    </p>

    <form method="POST" class="space-y-4">
        {% csrf_token %}
        <div>
            <label class="block text-gray-700 mb-1 font-medium">Enter Verification Code</label>
            <input type="text" name="otp" maxlength="6"
                class="w-full text-center tracking-[0.5em] text-2xl font-bold p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 uppercase"
                placeholder="------">
        </div>
        <button type="submit"
            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold text-lg shadow-sm transition">
            Verify Account
        </button>
    </form>

    <!-- Change Number Toggle -->
    <div class="text-center mt-6">
        <p class="text-sm text-gray-500 mb-2">Wrong number?</p>
        <button onclick="document.getElementById('changePhoneForm').classList.toggle('hidden')"
            class="text-indigo-600 font-medium hover:underline text-sm">
            Change Phone Number
        </button>

        <div id="changePhoneForm" class="hidden mt-4 pt-4 border-t border-gray-100">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="change_number" value="1">
                <div class="flex gap-2">
                    <p class="text-gray-500 mb-6">Please enter a valid phone number to verify your account and secure
                        your access.
                    </p>
                </div>

                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="change_number" value="1">

                    <div class="mb-5">
                        <label class="block text-left text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" name="new_phone" placeholder="+234 80 1234 5678"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-lg">
                    </div>

                    <button type="submit"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold text-lg shadow-sm transition flex justify-center items-center gap-2">
                        <span>Send OTP</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 7l5 5m0 0l-5 5m5-5H6" />
                        </svg>
                    </button>
                </form>
                {% endif %}

        </div>

        <script>
            {% if phone %}
            document.getElementById('resendOtpBtn').addEventListener('click', async () => {
                const res = await fetch("{% url 'send_otp_ajax' %}", {
                    method: "POST",
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                    body: new URLSearchParams({ phone: "{{ phone }}" })
                });
                const data = await res.json();
                alert(data.message);
            });
            {% endif %}
        </script>
        {% endblock %}