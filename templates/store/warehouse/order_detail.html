{% extends "base.html" %}
{% load humanize %}
{% block title %}Warehouse Order | {{ order.tracking_no }} | Jodise{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

    <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <div class="text-xs text-gray-500">Tracking</div>
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">{{ order.tracking_no }}</h1>
        <p class="text-sm text-gray-600 mt-1">
          Order: {{ order.reference }} • Status: <span class="font-semibold">{{ order.get_status_display }}</span>
        </p>
      </div>
      <a href="{% url 'warehouse_dashboard' %}" class="rounded-xl bg-white border border-gray-200 px-4 py-2 text-sm font-semibold hover:bg-gray-50">
        ← Back
      </a>
    </div>

    <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">

      <!-- Buyer -->
      <div class="rounded-2xl bg-white border border-gray-200 p-4">
        <p class="font-semibold text-gray-900">Buyer</p>
        <div class="mt-2 text-sm text-gray-700 space-y-1">
          <div><span class="text-gray-500">Email:</span> {{ order.buyer.email|default:"-" }}</div>
          <div><span class="text-gray-500">Phone:</span> {{ order.buyer.phone|default:"-" }}</div>
          <div><span class="text-gray-500">Address:</span> {{ order.buyer.full_address|default:"-" }}</div>
        </div>
      </div>

      <!-- Shipment -->
      <div class="rounded-2xl bg-white border border-gray-200 p-4 lg:col-span-2">
        <div class="flex items-center justify-between">
          <p class="font-semibold text-gray-900">Consolidated Shipment</p>
          <span class="inline-flex rounded-full border border-gray-200 bg-white px-2 py-1 text-xs font-semibold text-gray-700">
            {{ shipment.get_status_display }}
          </span>
        </div>

        <form method="POST" action="{% url 'warehouse_update_shipment' order.tracking_no %}" class="mt-3 grid grid-cols-1 md:grid-cols-4 gap-3">
          {% csrf_token %}
          <div>
            <label class="text-xs text-gray-600">Status</label>
            <select name="status" class="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 text-sm bg-white">
              {% for v, t in shipment.STATUS %}
                <option value="{{ v }}" {% if shipment.status == v %}selected{% endif %}>{{ t }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="text-xs text-gray-600">Carrier</label>
            <input name="carrier" value="{{ shipment.carrier|default:'' }}" class="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 text-sm bg-white" />
          </div>
          <div>
            <label class="text-xs text-gray-600">Carrier Tracking</label>
            <input name="tracking_number" value="{{ shipment.tracking_number|default:'' }}" class="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 text-sm bg-white" />
          </div>
          <div>
            <label class="text-xs text-gray-600">ETA (days)</label>
            <input name="eta_days" type="number" min="0" class="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 text-sm bg-white" placeholder="e.g. 2" />
          </div>

          <div class="md:col-span-4">
            <button class="w-full rounded-xl bg-black px-4 py-2 text-sm font-semibold text-white hover:bg-gray-900">
              Update Shipment
            </button>
          </div>
        </form>

        <div class="mt-3 text-xs text-gray-500 space-y-1">
          <div>Estimated delivery: {{ shipment.estimated_delivery|date:"M d, Y H:i"|default:"-" }}</div>
          <div>Dispatched: {{ shipment.dispatched_at|date:"M d, Y H:i"|default:"-" }}</div>
          <div>Delivered: {{ shipment.delivered_at|date:"M d, Y H:i"|default:"-" }}</div>
        </div>
      </div>
    </div>

    <!-- Seller Fulfillments -->
    <div class="mt-6 rounded-2xl bg-white border border-gray-200 overflow-hidden">
      <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
        <p class="font-semibold text-gray-900">Seller Packages</p>
        <p class="text-xs text-gray-500">Receive each seller package as it arrives</p>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50 text-gray-600">
            <tr>
              <th class="px-4 py-3 text-left">Seller</th>
              <th class="px-4 py-3 text-left">Status</th>
              <th class="px-4 py-3 text-left">Inbound Tracking</th>
              <th class="px-4 py-3 text-left">Received At</th>
              <th class="px-4 py-3 text-left">Action</th>
            </tr>
          </thead>

          <tbody class="divide-y divide-gray-100">
            {% for f in fulfillments %}
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 font-semibold text-gray-900">{{ f.seller.store_name }}</td>
              <td class="px-4 py-3">
                <span class="inline-flex rounded-full border border-gray-200 bg-white px-2 py-1 text-xs font-semibold text-gray-700">
                  {{ f.get_status_display }}
                </span>
              </td>
              <td class="px-4 py-3 text-gray-700">
                {% if f.inbound_carrier or f.inbound_tracking %}
                  {{ f.inbound_carrier|default:"-" }} • {{ f.inbound_tracking|default:"-" }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td class="px-4 py-3 text-gray-500">{{ f.received_at_warehouse_at|date:"M d, Y H:i"|default:"-" }}</td>
              <td class="px-4 py-3">
                {% if f.status != "received_at_warehouse" %}
                  <form method="POST" action="{% url 'warehouse_receive_seller_package' order.tracking_no f.id %}">
                    {% csrf_token %}
                    <button class="rounded-xl bg-emerald-600 px-3 py-2 text-xs font-semibold text-white hover:bg-emerald-700">
                      Mark Received
                    </button>
                  </form>
                {% else %}
                  <span class="text-xs font-semibold text-emerald-700">Received ✓</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Events Timeline -->
    <div class="mt-6 rounded-2xl bg-white border border-gray-200 p-4">
      <p class="font-semibold text-gray-900">Order Timeline</p>
      <div class="mt-3 space-y-2">
        {% for e in events %}
          <div class="flex items-start gap-3">
            <div class="mt-1 h-2 w-2 rounded-full bg-gray-400"></div>
            <div class="text-sm">
              <div class="text-gray-900 font-semibold">{{ e.message }}</div>
              <div class="text-xs text-gray-500">
                {{ e.created_at|date:"M d, Y H:i" }}
                {% if e.actor %} • {{ e.actor.email }}{% endif %}
                • <span class="font-mono">{{ e.code }}</span>
              </div>
            </div>
          </div>
        {% empty %}
          <p class="text-sm text-gray-500">No events yet.</p>
        {% endfor %}
      </div>
    </div>

  </div>
</div>
{% endblock %}
