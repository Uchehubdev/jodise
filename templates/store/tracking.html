{# templates/store/tracking.html #}
{% extends "base.html" %}
{% load humanize %}

{% block title %}Track Order | Jodise{% endblock %}
{% block meta_description %}Track your Jodise order in real-time using your tracking number. View shipping status, updates, and delivery progress.{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 pb-24">

  <!-- Top bar -->
  <section class="sticky top-0 z-40 border-b border-gray-200 bg-white/90 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="min-w-0">
          <h1 class="text-lg sm:text-2xl font-extrabold text-gray-900 truncate">
            ğŸ“¦ Track Your Order
          </h1>
          <p class="text-sm text-gray-600">
            Enter a tracking number (or order reference) to see live delivery updates.
          </p>
        </div>

        <div class="flex items-center gap-2">
          <a href="{% url 'store_home' %}"
             class="inline-flex items-center justify-center rounded-2xl border border-gray-200 bg-white px-4 py-2.5 text-sm font-bold text-gray-800 hover:bg-gray-50">
            ğŸ  Shop
          </a>
          <a href="{% url 'view_cart' %}"
             class="inline-flex items-center justify-center rounded-2xl bg-gray-900 px-4 py-2.5 text-sm font-bold text-white hover:bg-gray-800">
            ğŸ›’ Cart
          </a>
        </div>
      </div>

      <!-- Search form -->
      <form method="get" action="{% url 'track_order' %}" class="mt-4">
        <div class="flex flex-col sm:flex-row gap-2">
          <div class="flex-1 relative">
            <label class="sr-only" for="tracking_number">Tracking number</label>
            <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-gray-400">ğŸ”</span>
            <input
              id="tracking_number"
              name="tracking_number"
              value="{{ tracking_number|default_if_none:'' }}"
              placeholder="e.g. A3F9C2 (tracking) or order reference"
              autocomplete="off"
              class="w-full rounded-2xl border border-gray-200 bg-white pl-12 pr-4 py-3 text-sm sm:text-base shadow-sm
                     focus:outline-none focus:ring-2 focus:ring-emerald-500/30 focus:border-emerald-400"
            />
          </div>

          <div class="flex gap-2">
            <button type="submit"
                    class="inline-flex items-center justify-center rounded-2xl bg-emerald-600 px-5 py-3 text-sm font-extrabold text-white hover:bg-emerald-700 shadow-sm">
              Track
            </button>
            <a href="{% url 'track_order' %}"
               class="inline-flex items-center justify-center rounded-2xl border border-gray-200 bg-white px-5 py-3 text-sm font-extrabold text-gray-800 hover:bg-gray-50 shadow-sm">
              Clear
            </a>
          </div>
        </div>

        <p class="mt-2 text-xs text-gray-500">
          Tip: If you canâ€™t find your tracking number, check your order email/SMS from Jodise.
        </p>
      </form>
    </div>
  </section>

  <!-- Body -->
  <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div id="trackingResult"
         data-refresh-url="{% if tracking_number %}{% url 'track_order' %}?tracking_number={{ tracking_number|urlencode }}{% endif %}">

      {% if not tracking_number %}
        <!-- Empty intro state -->
        <div class="bg-white border border-gray-200 rounded-2xl p-8 shadow-sm text-center">
          <div class="text-5xl">ğŸ§¾</div>
          <h2 class="mt-3 text-lg sm:text-xl font-extrabold text-gray-900">Track any order in seconds</h2>
          <p class="mt-2 text-sm text-gray-600 max-w-xl mx-auto">
            Enter your tracking number to view shipping progress, delivery events, and current order status.
          </p>

          <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3 text-left">
            <div class="rounded-2xl border border-gray-200 bg-gray-50 p-4">
              <p class="text-sm font-extrabold text-gray-900">âœ… Order status</p>
              <p class="text-xs text-gray-600 mt-1">Pending â†’ Paid â†’ Processing â†’ Shipped â†’ Completed</p>
            </div>
            <div class="rounded-2xl border border-gray-200 bg-gray-50 p-4">
              <p class="text-sm font-extrabold text-gray-900">ğŸ“ Delivery events</p>
              <p class="text-xs text-gray-600 mt-1">Assigned â†’ Picked up â†’ In transit â†’ Delivered</p>
            </div>
            <div class="rounded-2xl border border-gray-200 bg-gray-50 p-4">
              <p class="text-sm font-extrabold text-gray-900">ğŸ” Live refresh</p>
              <p class="text-xs text-gray-600 mt-1">This page can auto-refresh while you watch.</p>
            </div>
          </div>
        </div>

      {% else %}
        {% if not order and not delivery %}
          <!-- Not found -->
          <div class="bg-white border border-gray-200 rounded-2xl p-8 shadow-sm text-center">
            <div class="text-5xl">ğŸ˜•</div>
            <h2 class="mt-3 text-lg sm:text-xl font-extrabold text-gray-900">No matching order found</h2>
            <p class="mt-2 text-sm text-gray-600 max-w-xl mx-auto">
              We couldnâ€™t find an order for:
              <span class="font-extrabold text-gray-900">â€œ{{ tracking_number }}â€</span>.
              Double-check the code and try again.
            </p>

            <div class="mt-6 flex flex-col sm:flex-row items-center justify-center gap-2">
              <a href="{% url 'track_order' %}"
                 class="rounded-2xl bg-emerald-600 px-6 py-3 text-sm font-extrabold text-white hover:bg-emerald-700">
                Try another
              </a>
              <a href="{% url 'store_home' %}"
                 class="rounded-2xl border border-gray-200 bg-white px-6 py-3 text-sm font-extrabold text-gray-800 hover:bg-gray-50">
                Continue shopping
              </a>
            </div>

            <p class="mt-5 text-xs text-gray-500">
              If you still canâ€™t find it, contact support and share your order reference.
            </p>
          </div>

        {% else %}
          <!-- Found -->
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <!-- Left: Status & timeline -->
            <div class="lg:col-span-8 space-y-4">

              <!-- Summary card -->
              <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-5 sm:p-6">
                <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
                  <div class="min-w-0">
                    <h2 class="text-base sm:text-lg font-extrabold text-gray-900">
                      Tracking Overview
                    </h2>
                    <p class="text-sm text-gray-600 mt-1">
                      Tracking: <span class="font-extrabold text-gray-900">{{ tracking_number }}</span>
                      <button type="button"
                              class="ml-2 text-xs font-extrabold text-emerald-700 hover:text-emerald-900 underline"
                              data-copy-tracking="{{ tracking_number|escapejs }}">
                        Copy
                      </button>
                    </p>

                    {% if order %}
                      <p class="text-xs text-gray-500 mt-1">
                        Order status:
                        <span class="font-extrabold text-gray-900">{{ order.status|title }}</span>
                        {% if order.updated_at %} â€¢ Updated {{ order.updated_at|naturaltime }}{% endif %}
                      </p>
                    {% endif %}

                    {% if delivery and delivery.status %}
                      <p class="text-xs text-gray-500 mt-1">
                        Delivery status:
                        <span class="font-extrabold text-gray-900">{{ delivery.status|title }}</span>
                        {% if delivery.updated_at %} â€¢ Updated {{ delivery.updated_at|naturaltime }}{% endif %}
                      </p>
                    {% endif %}
                  </div>

                  <div class="flex gap-2">
                    <button type="button"
                            id="btnRefresh"
                            class="inline-flex items-center justify-center rounded-2xl border border-gray-200 bg-white px-4 py-2.5 text-sm font-extrabold text-gray-800 hover:bg-gray-50">
                      ğŸ”„ Refresh
                    </button>

                    <button type="button"
                            id="btnAuto"
                            class="inline-flex items-center justify-center rounded-2xl bg-gray-900 px-4 py-2.5 text-sm font-extrabold text-white hover:bg-gray-800">
                      â± Auto: Off
                    </button>
                  </div>
                </div>

                <!-- Timeline (Order) -->
                {% if order %}
                  {% with s=order.status %}
                    <div class="mt-6">
                      <p class="text-sm font-extrabold text-gray-900 mb-3">Order timeline</p>

                      <div class="grid grid-cols-5 gap-2 text-center">
                        {% comment %} helpers: mark active if reached {% endcomment %}
                        <div class="rounded-2xl border px-2 py-3 text-xs font-bold
                          {% if s == 'pending' or s == 'paid' or s == 'processing' or s == 'shipped' or s == 'completed' %}border-emerald-200 bg-emerald-50 text-emerald-800{% else %}border-gray-200 bg-gray-50 text-gray-500{% endif %}">
                          ğŸ§¾<div class="mt-1">Pending</div>
                        </div>

                        <div class="rounded-2xl border px-2 py-3 text-xs font-bold
                          {% if s == 'paid' or s == 'processing' or s == 'shipped' or s == 'completed' %}border-emerald-200 bg-emerald-50 text-emerald-800{% else %}border-gray-200 bg-gray-50 text-gray-500{% endif %}">
                          ğŸ’³<div class="mt-1">Paid</div>
                        </div>

                        <div class="rounded-2xl border px-2 py-3 text-xs font-bold
                          {% if s == 'processing' or s == 'shipped' or s == 'completed' %}border-emerald-200 bg-emerald-50 text-emerald-800{% else %}border-gray-200 bg-gray-50 text-gray-500{% endif %}">
                          ğŸ­<div class="mt-1">Processing</div>
                        </div>

                        <div class="rounded-2xl border px-2 py-3 text-xs font-bold
                          {% if s == 'shipped' or s == 'completed' %}border-emerald-200 bg-emerald-50 text-emerald-800{% else %}border-gray-200 bg-gray-50 text-gray-500{% endif %}">
                          ğŸšš<div class="mt-1">Shipped</div>
                        </div>

                        <div class="rounded-2xl border px-2 py-3 text-xs font-bold
                          {% if s == 'completed' %}border-emerald-200 bg-emerald-50 text-emerald-800{% else %}border-gray-200 bg-gray-50 text-gray-500{% endif %}">
                          âœ…<div class="mt-1">Completed</div>
                        </div>
                      </div>

                      {% if s == "cancelled" %}
                        <div class="mt-3 rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm font-bold text-red-800">
                          âŒ This order was cancelled.
                        </div>
                      {% endif %}
                    </div>
                  {% endwith %}
                {% endif %}

                <!-- Shipment (Store model) -->
                {% if order and order.shipments.all %}
                  {% with sh=order.shipments.all|last %}
                    <div class="mt-6">
                      <p class="text-sm font-extrabold text-gray-900 mb-2">Shipment</p>
                      <div class="rounded-2xl border border-gray-200 bg-gray-50 p-4">
                        <div class="flex flex-wrap items-center justify-between gap-2">
                          <div class="text-sm text-gray-700">
                            <span class="font-extrabold text-gray-900">Carrier:</span>
                            {{ sh.carrier|default:"â€”" }}
                          </div>
                          <div class="text-sm text-gray-700">
                            <span class="font-extrabold text-gray-900">Status:</span>
                            {{ sh.status|default:"â€”"|title }}
                          </div>
                        </div>

                        <div class="mt-2 text-sm text-gray-700">
                          <span class="font-extrabold text-gray-900">Tracking number:</span>
                          {{ sh.tracking_number|default:"â€”" }}
                        </div>

                        <div class="mt-2 text-xs text-gray-500">
                          {% if sh.estimated_delivery %}
                            Estimated delivery: <span class="font-bold text-gray-700">{{ sh.estimated_delivery|date:"M d, Y g:i A" }}</span>
                          {% endif %}
                          {% if sh.delivered_at %}
                            â€¢ Delivered: <span class="font-bold text-gray-700">{{ sh.delivered_at|date:"M d, Y g:i A" }}</span>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  {% endwith %}
                {% endif %}

                <!-- Delivery app (if present) -->
                {% if delivery %}
                  <div class="mt-6">
                    <p class="text-sm font-extrabold text-gray-900 mb-2">Delivery updates</p>
                    <div class="rounded-2xl border border-gray-200 bg-gray-50 p-4">
                      <div class="flex flex-wrap items-center justify-between gap-2">
                        <div class="text-sm text-gray-700">
                          <span class="font-extrabold text-gray-900">Delivery:</span>
                          {{ delivery.status|default:"â€”"|title }}
                        </div>
                        <div class="text-sm text-gray-700">
                          <span class="font-extrabold text-gray-900">Code:</span>
                          {{ delivery.order_code|default:delivery.tracking_number|default:"â€”" }}
                        </div>
                      </div>

                      {% if delivery.tracking_history.all %}
                        <div class="mt-3 space-y-2">
                          {% for h in delivery.tracking_history.all %}
                            <div class="flex items-start gap-3">
                              <div class="mt-1 w-2 h-2 rounded-full bg-emerald-600"></div>
                              <div class="min-w-0">
                                <p class="text-sm font-bold text-gray-900">
                                  {{ h.status|default:"Update"|title }}
                                  {% if h.created_at %}<span class="text-xs font-semibold text-gray-500"> â€¢ {{ h.created_at|naturaltime }}</span>{% endif %}
                                </p>
                                {% if h.note %}
                                  <p class="text-xs text-gray-600 mt-0.5">{{ h.note }}</p>
                                {% endif %}
                                {% if h.location %}
                                  <p class="text-xs text-gray-500 mt-0.5">ğŸ“ {{ h.location }}</p>
                                {% endif %}
                              </div>
                            </div>
                          {% endfor %}
                        </div>
                      {% else %}
                        <p class="text-sm text-gray-600 mt-2">No delivery history yet.</p>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
              </div>

              <!-- Items (safe) -->
              {% if order and order.items.all %}
                <div class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
                  <div class="px-5 sm:px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                    <h3 class="text-base font-extrabold text-gray-900">Items</h3>
                    <span class="text-xs text-gray-500">{{ order.items.count }} item{{ order.items.count|pluralize }}</span>
                  </div>

                  <div class="divide-y divide-gray-100">
                    {% for it in order.items.all %}
                      <div class="p-5 sm:p-6 flex gap-4">
                        <a href="{{ it.product.get_absolute_url }}" class="shrink-0">
                          <div class="w-20 h-16 rounded-xl bg-gray-100 border border-gray-200 overflow-hidden">
                            {% with img=it.product.images.all|first %}
                              {% if img and img.image %}
                                <img src="{{ img.image.url }}" alt="{{ it.product.name }}" class="w-full h-full object-cover">
                              {% else %}
                                <div class="w-full h-full flex items-center justify-center text-[10px] text-gray-400">No image</div>
                              {% endif %}
                            {% endwith %}
                          </div>
                        </a>

                        <div class="min-w-0 flex-1">
                          <a href="{{ it.product.get_absolute_url }}"
                             class="font-extrabold text-gray-900 text-sm hover:text-emerald-700 line-clamp-2">
                            {{ it.product.name }}
                          </a>

                          <div class="mt-1 flex flex-wrap gap-2 text-xs text-gray-600">
                            <span>Qty: <span class="font-bold text-gray-900">{{ it.quantity }}</span></span>
                            <span class="text-gray-300">â€¢</span>
                            <span>Unit: <span class="font-bold text-gray-900">{{ it.unit_price }}</span></span>
                            <span class="text-gray-300">â€¢</span>
                            <span>Subtotal: <span class="font-bold text-gray-900">{{ it.subtotal }}</span></span>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            </div>

            <!-- Right: Order details / help -->
            <aside class="lg:col-span-4 space-y-4">

              <!-- Order details -->
              <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-5 sm:p-6 lg:sticky lg:top-24">
                <h3 class="text-base font-extrabold text-gray-900">Details</h3>

                <div class="mt-4 space-y-3 text-sm">
                  {% if order %}
                    <div class="flex items-center justify-between gap-3">
                      <span class="text-gray-600">Order reference</span>
                      <span class="font-extrabold text-gray-900 truncate max-w-[200px]">
                        {{ order.reference }}
                      </span>
                    </div>

                    <div class="flex items-center justify-between gap-3">
                      <span class="text-gray-600">Tracking no.</span>
                      <span class="font-extrabold text-gray-900">
                        {{ order.tracking_no|default:"â€”" }}
                      </span>
                    </div>

                    <div class="flex items-center justify-between gap-3">
                      <span class="text-gray-600">Created</span>
                      <span class="font-extrabold text-gray-900">
                        {{ order.created_at|date:"M d, Y" }}
                      </span>
                    </div>

                    <div class="h-px bg-gray-200 my-2"></div>

                    <div class="flex items-center justify-between gap-3">
                      <span class="text-gray-600">Subtotal</span>
                      <span class="font-extrabold text-gray-900">{{ order.subtotal|default:"0" }}</span>
                    </div>
                    <div class="flex items-center justify-between gap-3">
                      <span class="text-gray-600">VAT</span>
                      <span class="font-extrabold text-gray-900">{{ order.vat|default:"0" }}</span>
                    </div>
                    <div class="flex items-center justify-between gap-3">
                      <span class="text-gray-600">Delivery fee</span>
                      <span class="font-extrabold text-gray-900">{{ order.delivery_fee|default:"0" }}</span>
                    </div>
                    <div class="flex items-center justify-between gap-3">
                      <span class="text-gray-900 font-extrabold">Total</span>
                      <span class="text-lg font-extrabold text-emerald-700">{{ order.total|default:"0" }}</span>
                    </div>

                    {% if request.user.is_authenticated and order.buyer_id == request.user.id %}
                      <div class="mt-4 rounded-2xl border border-emerald-200 bg-emerald-50 p-4 text-sm">
                        <p class="font-extrabold text-emerald-900">âœ… Youâ€™re viewing your own order</p>
                        <p class="text-xs text-emerald-800 mt-1">
                          Full details are visible because youâ€™re logged in.
                        </p>
                      </div>
                    {% else %}
                      <div class="mt-4 rounded-2xl border border-gray-200 bg-gray-50 p-4 text-sm">
                        <p class="font-extrabold text-gray-900">ğŸ”’ Privacy protected</p>
                        <p class="text-xs text-gray-600 mt-1">
                          Some personal details are hidden on public tracking pages.
                        </p>
                      </div>
                    {% endif %}
                  {% else %}
                    <div class="text-sm text-gray-600">
                      Order details not available, but delivery tracking may still show updates.
                    </div>
                  {% endif %}
                </div>

                <div class="mt-5 flex flex-col gap-2">
                  <a href="{% url 'store_home' %}"
                     class="inline-flex items-center justify-center rounded-2xl bg-gray-900 px-4 py-3 text-sm font-extrabold text-white hover:bg-gray-800">
                    Continue shopping
                  </a>
                  <a href="{% url 'search_products' %}"
                     class="inline-flex items-center justify-center rounded-2xl border border-gray-200 bg-white px-4 py-3 text-sm font-extrabold text-gray-800 hover:bg-gray-50">
                    Browse deals
                  </a>
                </div>
              </div>

              <!-- Help -->
              <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-5 sm:p-6">
                <h3 class="text-base font-extrabold text-gray-900">Need help?</h3>
                <p class="mt-2 text-sm text-gray-600">
                  If your tracking is stuck for too long, contact support with your tracking number.
                </p>

                <div class="mt-4 space-y-2 text-sm">
                  <div class="rounded-2xl border border-gray-200 bg-gray-50 px-4 py-3">
                    <p class="font-extrabold text-gray-900">Whatâ€™s next?</p>
                    <p class="text-xs text-gray-600 mt-1">
                      When your order is shipped, youâ€™ll see â€œIn transitâ€ and delivery events will start appearing.
                    </p>
                  </div>
                </div>
              </div>

            </aside>

          </div>
        {% endif %}
      {% endif %}
    </div>
  </section>
</div>

<!-- Toast host -->
<div id="toastHost" class="fixed top-4 right-4 z-[9999] space-y-2"></div>

<script>
(function () {
  // --------------------
  // Toasts
  // --------------------
  const toastHost = document.getElementById("toastHost");
  function toast(msg, type) {
    if (!toastHost) return;
    const el = document.createElement("div");
    const base = "px-4 py-3 rounded-2xl shadow-lg border text-sm font-semibold flex items-start gap-2 bg-white";
    const themes = {
      success: "border-emerald-200 text-emerald-900 bg-emerald-50",
      info: "border-blue-200 text-blue-900 bg-blue-50",
      warn: "border-amber-200 text-amber-900 bg-amber-50",
      error: "border-red-200 text-red-900 bg-red-50",
    };
    el.className = base + " " + (themes[type || "info"] || themes.info);
    el.innerHTML = `<span class="mt-[1px]">${type === "success" ? "âœ…" : type === "warn" ? "âš ï¸" : type === "error" ? "âŒ" : "â„¹ï¸"}</span>
                    <div class="min-w-0">${msg}</div>`;
    toastHost.appendChild(el);
    setTimeout(() => {
      el.style.opacity = "0";
      el.style.transform = "translateY(-6px)";
      el.style.transition = "all .25s ease";
      setTimeout(() => el.remove(), 250);
    }, 2200);
  }

  // --------------------
  // Copy tracking
  // --------------------
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest("[data-copy-tracking]");
    if (!btn) return;
    const value = btn.getAttribute("data-copy-tracking") || "";
    try {
      await navigator.clipboard.writeText(value);
      toast("Tracking number copied.", "success");
    } catch (_) {
      toast("Copy failed. Select and copy manually.", "warn");
    }
  });

  // --------------------
  // Live refresh (no full page reload)
  // --------------------
  const result = document.getElementById("trackingResult");
  const btnRefresh = document.getElementById("btnRefresh");
  const btnAuto = document.getElementById("btnAuto");
  let auto = false;
  let timer = null;

  async function refreshTracking() {
    if (!result) return;
    const url = result.getAttribute("data-refresh-url");
    if (!url) return;

    // small busy state
    if (btnRefresh) {
      btnRefresh.disabled = true;
      btnRefresh.classList.add("opacity-60");
      btnRefresh.textContent = "ğŸ”„ Refreshing...";
    }

    try {
      const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }, credentials: "same-origin" });
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, "text/html");
      const updated = doc.getElementById("trackingResult");
      if (updated && result) {
        result.innerHTML = updated.innerHTML;
        // re-set refresh url if it changed
        const newUrl = updated.getAttribute("data-refresh-url");
        if (newUrl) result.setAttribute("data-refresh-url", newUrl);
        toast("Tracking updated.", "info");
      }
    } catch (e) {
      toast("Could not refresh tracking right now.", "warn");
    } finally {
      if (btnRefresh) {
        btnRefresh.disabled = false;
        btnRefresh.classList.remove("opacity-60");
        btnRefresh.textContent = "ğŸ”„ Refresh";
      }
    }
  }

  function setAuto(on) {
    auto = !!on;
    if (btnAuto) btnAuto.textContent = auto ? "â± Auto: On" : "â± Auto: Off";
    if (timer) clearInterval(timer);
    timer = null;
    if (auto) timer = setInterval(refreshTracking, 25000);
  }

  if (btnRefresh) btnRefresh.addEventListener("click", refreshTracking);
  if (btnAuto) btnAuto.addEventListener("click", () => setAuto(!auto));

  // Auto-enable if a tracking number exists (gentle)
  if (result && result.getAttribute("data-refresh-url")) {
    // keep OFF by default; user can enable.
  }
})();
</script>
{% endblock %}
