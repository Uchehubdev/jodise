{# templates/store/seller_dashboard.html #}
{% extends "base.html" %}
{% load humanize %}

{% block title %}Seller Dashboard | Jodise{% endblock %}

{% block content %}
<style>
  [x-cloak] { display: none !important; }
</style>

<div class="min-h-screen bg-gray-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

    <!-- Header -->
    <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <div class="inline-flex items-center gap-2 rounded-full bg-white border border-gray-200 px-3 py-1 text-xs font-semibold text-gray-700">
          <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
          Verified Seller
        </div>

        <h1 class="mt-2 text-2xl sm:text-3xl font-bold text-gray-900">Seller Dashboard</h1>
        <p class="text-gray-600 mt-1">
          Store: <span class="font-semibold">{{ seller.store_name }}</span>
        </p>

        <!-- quick helper -->
        <div class="mt-2 flex flex-wrap gap-2 text-xs text-gray-500">
          <span class="inline-flex items-center gap-1 rounded-full border border-gray-200 bg-white px-2 py-1">
            <span class="h-1.5 w-1.5 rounded-full bg-indigo-500"></span>
            Paid not shipped: <span class="font-semibold text-gray-900">{{ pending_shipments|intcomma }}</span>
          </span>
          <span class="inline-flex items-center gap-1 rounded-full border border-gray-200 bg-white px-2 py-1">
            <span class="h-1.5 w-1.5 rounded-full bg-amber-500"></span>
            Low stock: <span class="font-semibold text-gray-900">{{ low_stock_count|intcomma }}</span>
          </span>
          <a href="{% url 'seller_orders' %}"
             class="inline-flex items-center gap-1 rounded-full border border-gray-200 bg-white px-2 py-1 hover:bg-gray-50">
            <span class="h-1.5 w-1.5 rounded-full bg-gray-700"></span>
            Manage Orders
          </a>
        </div>
      </div>

      <div class="flex flex-col sm:flex-row gap-2">
        <a href="{% url 'add_product' %}"
           class="inline-flex items-center justify-center rounded-xl bg-black px-4 py-2 text-sm font-semibold text-white hover:bg-gray-900">
          + Add Product
        </a>

        <a href="{% url 'request_payout' %}"
           class="inline-flex items-center justify-center rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700">
          Withdraw
        </a>

        <a href="{% url 'seller_settings' %}"
           class="inline-flex items-center justify-center rounded-xl bg-white px-4 py-2 text-sm font-semibold text-gray-900 border border-gray-200 hover:bg-gray-50">
          Store Settings
        </a>
      </div>
    </div>

    <!-- Stats -->
    <div class="mt-6 grid grid-cols-2 lg:grid-cols-6 gap-3">
      <div class="rounded-2xl bg-white border border-gray-200 p-4">
        <p class="text-xs text-gray-500">Total Products</p>
        <p class="text-xl font-bold text-gray-900">{{ products_count|intcomma }}</p>
      </div>

      <div class="rounded-2xl bg-white border border-gray-200 p-4">
        <p class="text-xs text-gray-500">Active</p>
        <p class="text-xl font-bold text-emerald-700">{{ active_count|intcomma }}</p>
      </div>

      <div class="rounded-2xl bg-white border border-gray-200 p-4">
        <p class="text-xs text-gray-500">Inactive</p>
        <p class="text-xl font-bold text-gray-700">{{ inactive_count|intcomma }}</p>
      </div>

      <div class="rounded-2xl bg-white border border-gray-200 p-4">
        <p class="text-xs text-gray-500">Low Stock (&lt; 5)</p>
        <p class="text-xl font-bold text-amber-700">{{ low_stock_count|intcomma }}</p>
      </div>

      <div class="rounded-2xl bg-white border border-gray-200 p-4">
        <p class="text-xs text-gray-500">Out of Stock</p>
        <p class="text-xl font-bold text-red-700">{{ out_of_stock_count|intcomma }}</p>
      </div>

      <div class="rounded-2xl bg-white border border-gray-200 p-4">
        <p class="text-xs text-gray-500">Paid not shipped</p>
        <p class="text-xl font-bold text-indigo-700">{{ pending_shipments|intcomma }}</p>
      </div>
    </div>

    <!-- Earnings -->
    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
      <div class="rounded-2xl bg-white border border-gray-200 p-4">
        <p class="text-xs text-gray-500">Total Earnings</p>
        <p class="text-2xl font-bold text-gray-900">
          {{ currency_symbol }}{{ total_earnings|floatformat:2|intcomma }}
        </p>
        <p class="mt-1 text-xs text-gray-500">Across all your completed orders & payouts.</p>
      </div>

      <div class="rounded-2xl bg-white border border-gray-200 p-4">
        <p class="text-xs text-gray-500">Last 30 Days</p>
        <p class="text-2xl font-bold text-gray-900">
          {{ currency_symbol }}{{ month_earnings|floatformat:2|intcomma }}
        </p>
        <p class="mt-1 text-xs text-gray-500">Your recent performance trend.</p>
      </div>

      <div class="rounded-2xl bg-white border border-gray-200 p-4">
        <p class="text-xs text-gray-500">Orders (Unique)</p>
        <p class="text-2xl font-bold text-gray-900">{{ total_orders|intcomma }}</p>
        <p class="mt-1 text-xs text-gray-500">Unique orders containing your products.</p>
      </div>
    </div>

    <!-- Recent Orders -->
    <div class="mt-6 rounded-2xl bg-white border border-gray-200 overflow-hidden">
      <div class="px-4 py-3 border-b border-gray-200 flex items-start sm:items-center justify-between gap-3">
        <div>
          <p class="font-semibold text-gray-900">Recent Orders Containing Your Items</p>
          <p class="text-xs text-gray-500">
            If an order is <span class="font-semibold">Paid</span>, pack items and send to warehouse (consolidation flow).
          </p>
        </div>
        <div class="flex items-center gap-2">
          <div class="text-xs text-gray-500">
            Showing latest {{ orders_to_fulfill|length }} orders
          </div>
          <a href="{% url 'seller_orders' %}"
             class="hidden sm:inline-flex rounded-xl bg-white border border-gray-200 px-3 py-2 text-xs font-semibold hover:bg-gray-50">
            View all
          </a>
        </div>
      </div>

      <div class="divide-y divide-gray-100">
        {% for o in orders_to_fulfill %}
          <div class="px-4 py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div class="min-w-0">
              <div class="flex flex-wrap items-center gap-2">
                <span class="text-sm font-semibold text-gray-900">
                  Order {{ o.tracking_no|default:o.reference }}
                </span>

                {% if o.status == "paid" %}
                  <span class="inline-flex rounded-full bg-indigo-100 px-2 py-1 text-[11px] font-semibold text-indigo-700">Paid</span>
                {% elif o.status == "processing" %}
                  <span class="inline-flex rounded-full bg-amber-100 px-2 py-1 text-[11px] font-semibold text-amber-700">Processing</span>
                {% elif o.status == "shipped" %}
                  <span class="inline-flex rounded-full bg-sky-100 px-2 py-1 text-[11px] font-semibold text-sky-700">Shipped</span>
                {% elif o.status == "completed" %}
                  <span class="inline-flex rounded-full bg-emerald-100 px-2 py-1 text-[11px] font-semibold text-emerald-700">Completed</span>
                {% elif o.status == "cancelled" %}
                  <span class="inline-flex rounded-full bg-red-100 px-2 py-1 text-[11px] font-semibold text-red-700">Cancelled</span>
                {% else %}
                  <span class="inline-flex rounded-full bg-gray-100 px-2 py-1 text-[11px] font-semibold text-gray-700">{{ o.status|title }}</span>
                {% endif %}
              </div>

              <div class="mt-1 text-xs text-gray-500 flex flex-wrap gap-2">
                <span>Placed: {{ o.created_at|naturaltime }}</span>
                {% if o.buyer %}
                  <span class="hidden sm:inline">‚Ä¢</span>
                  <span>Buyer: {{ o.buyer.first_name }} {{ o.buyer.last_name }}</span>
                {% endif %}
              </div>
            </div>

            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-600">Total:</span>
              <span class="text-sm font-bold text-gray-900">{{ currency_symbol }}{{ o.total|floatformat:2|intcomma }}</span>

              <a href="{% url 'seller_order_detail' o.id %}"
                 class="ml-2 rounded-xl bg-white border border-gray-200 px-3 py-2 text-xs font-semibold hover:bg-gray-50">
                Open
              </a>
            </div>
          </div>
        {% empty %}
          <div class="px-4 py-10 text-center">
            <div class="mx-auto h-12 w-12 rounded-2xl bg-gray-100 flex items-center justify-center border border-gray-200">
              <span class="text-gray-500 text-sm">üßæ</span>
            </div>
            <h3 class="mt-3 text-lg font-bold text-gray-900">No orders yet</h3>
            <p class="mt-1 text-sm text-gray-500">Once buyers purchase, your recent orders will appear here.</p>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Filters -->
    <form method="GET" class="mt-6 rounded-2xl bg-white border border-gray-200 p-4">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
        <div class="md:col-span-5">
          <label class="text-xs text-gray-600">Search</label>
          <input name="q" value="{{ q }}"
                 placeholder="Search by name or SKU..."
                 class="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-black/10">
        </div>

        <div class="md:col-span-2">
          <label class="text-xs text-gray-600">Status</label>
          <select name="status" class="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 text-sm bg-white">
            <option value="all" {% if status == "all" %}selected{% endif %}>All</option>
            <option value="active" {% if status == "active" %}selected{% endif %}>Active</option>
            <option value="inactive" {% if status == "inactive" %}selected{% endif %}>Inactive</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="text-xs text-gray-600">Stock</label>
          <select name="stock" class="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 text-sm bg-white">
            <option value="all" {% if stock == "all" %}selected{% endif %}>All</option>
            <option value="in" {% if stock == "in" %}selected{% endif %}>In stock</option>
            <option value="out" {% if stock == "out" %}selected{% endif %}>Out of stock</option>
            <option value="low" {% if stock == "low" %}selected{% endif %}>Low stock</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="text-xs text-gray-600">Sort</label>
          <select name="sort" class="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 text-sm bg-white">
            <option value="new" {% if sort == "new" %}selected{% endif %}>Newest</option>
            <option value="old" {% if sort == "old" %}selected{% endif %}>Oldest</option>
            <option value="price_asc" {% if sort == "price_asc" %}selected{% endif %}>Price ‚Üë</option>
            <option value="price_desc" {% if sort == "price_desc" %}selected{% endif %}>Price ‚Üì</option>
            <option value="stock_asc" {% if sort == "stock_asc" %}selected{% endif %}>Stock ‚Üë</option>
            <option value="stock_desc" {% if sort == "stock_desc" %}selected{% endif %}>Stock ‚Üì</option>
            <option value="name_asc" {% if sort == "name_asc" %}selected{% endif %}>Name A‚ÜíZ</option>
            <option value="name_desc" {% if sort == "name_desc" %}selected{% endif %}>Name Z‚ÜíA</option>
          </select>
        </div>

        <div class="md:col-span-1 flex items-end">
          <button class="w-full rounded-xl bg-black px-3 py-2 text-sm font-semibold text-white hover:bg-gray-900">
            Apply
          </button>
        </div>
      </div>

      <div class="mt-3 flex items-center justify-between">
        <p class="text-xs text-gray-500">
          Tip: Use ‚ÄúLow stock‚Äù to quickly restock items before buyers order.
        </p>
        <a href="{% url 'seller_dashboard' %}"
           class="text-xs font-semibold text-gray-900 hover:underline">
          Reset filters
        </a>
      </div>
    </form>

    <!-- Bulk actions -->
    <div class="mt-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex flex-col sm:flex-row sm:items-center gap-2">
        <div class="flex items-center gap-2">
          <select id="bulkAction" class="rounded-xl border border-gray-200 px-3 py-2 text-sm bg-white">
            <option value="">Bulk actions</option>
            <option value="activate">Activate</option>
            <option value="deactivate">Deactivate</option>
            <option value="delete">Delete</option>
          </select>
          <button id="runBulk"
                  class="rounded-xl bg-white border border-gray-200 px-3 py-2 text-sm font-semibold hover:bg-gray-50">
            Run
          </button>

          <button id="selectAllVisible"
                  type="button"
                  class="rounded-xl bg-white border border-gray-200 px-3 py-2 text-sm font-semibold hover:bg-gray-50">
            Select visible
          </button>

          <button id="clearVisible"
                  type="button"
                  class="rounded-xl bg-white border border-gray-200 px-3 py-2 text-sm font-semibold hover:bg-gray-50">
            Clear
          </button>
        </div>

        <div class="text-xs text-gray-500">
          Selected: <span id="selectedCount" class="font-semibold text-gray-900">0</span>
        </div>
      </div>

      <div id="toast" class="hidden text-xs font-semibold rounded-xl border border-gray-200 bg-white px-3 py-2 text-gray-700"></div>
    </div>

    <!-- Products -->
    <div class="mt-4 rounded-2xl bg-white border border-gray-200 overflow-hidden" id="productsWrap">
      <div class="px-4 py-3 border-b border-gray-200 flex items-start sm:items-center justify-between gap-3">
        <div>
          <p class="font-semibold text-gray-900">Your Products</p>
          <p class="text-xs text-gray-500">
            {% if products.paginator.count %}
              Showing {{ products.start_index }}‚Äì{{ products.end_index }} of {{ products.paginator.count|intcomma }}
            {% else %}
              No items
            {% endif %}
          </p>
        </div>

        <div class="text-xs text-gray-500">
          Page <span class="font-semibold text-gray-900">{{ products.number }}</span> / {{ products.paginator.num_pages }}
        </div>
      </div>

      {# Mobile Cards (smaller screens) #}
      <div class="md:hidden divide-y divide-gray-100">
        {% for product in products %}
          <div id="row-{{ product.id }}" class="p-4">
            <div class="flex items-start gap-3">
              <input type="checkbox" class="rowCheck mt-1 h-4 w-4 rounded border-gray-300" value="{{ product.id }}" aria-label="Select product">

              <div class="h-14 w-14 rounded-2xl bg-gray-100 overflow-hidden flex-shrink-0 border border-gray-200">
                {% with img=product.images.first %}
                  {% if img %}
                    <img src="{{ img.image.url }}" class="h-full w-full object-cover" alt="{{ product.name|escape }}">
                  {% else %}
                    <div class="h-full w-full flex items-center justify-center text-[10px] text-gray-500">No image</div>
                  {% endif %}
                {% endwith %}
              </div>

              <div class="min-w-0 flex-1">
                <div class="flex items-start justify-between gap-2">
                  <div class="min-w-0">
                    <p class="font-semibold text-gray-900 leading-tight truncate">{{ product.name }}</p>
                    <p class="mt-1 text-xs text-gray-500">SKU: {{ product.sku }}</p>
                  </div>

                  <button
                    type="button"
                    class="toggleStatus inline-flex items-center gap-2 rounded-xl border border-gray-200 px-3 py-2 text-xs font-semibold bg-white hover:bg-gray-50"
                    data-product-id="{{ product.id }}"
                    data-url="{% url 'toggle_product_status' product.id %}">
                    <span class="statusDot h-2 w-2 rounded-full {% if product.is_active %}bg-emerald-500{% else %}bg-gray-400{% endif %}"></span>
                    <span class="statusLabel">{% if product.is_active %}Active{% else %}Inactive{% endif %}</span>
                  </button>
                </div>

                <div class="mt-2 flex flex-wrap items-center gap-2">
                  <span class="text-sm font-bold text-gray-900">
                    {{ currency_symbol }}{{ product.price|floatformat:2|intcomma }}
                  </span>

                  {% if product.stock|default:0 <= 0 %}
                    <span class="inline-flex rounded-full bg-red-100 px-2 py-1 text-[11px] font-semibold text-red-700">Out</span>
                  {% elif product.stock < 5 %}
                    <span class="inline-flex rounded-full bg-amber-100 px-2 py-1 text-[11px] font-semibold text-amber-700">Low ({{ product.stock }})</span>
                  {% else %}
                    <span class="inline-flex rounded-full bg-emerald-100 px-2 py-1 text-[11px] font-semibold text-emerald-700">Stock: {{ product.stock }}</span>
                  {% endif %}

                  {% if product.category %}
                    <span class="text-[11px] rounded-full border border-gray-200 bg-white px-2 py-0.5 text-gray-700">
                      {{ product.category.name }}
                    </span>
                  {% endif %}
                </div>

                <div class="mt-3 flex flex-wrap gap-2">
                  <a href="{% url 'edit_product' product.id %}"
                     class="rounded-xl bg-black px-3 py-2 text-xs font-semibold text-white hover:bg-gray-900">
                    Edit
                  </a>
                  <a href="{% url 'upload_product_image' product.id %}"
                     class="rounded-xl bg-white border border-gray-200 px-3 py-2 text-xs font-semibold hover:bg-gray-50">
                    Images
                  </a>
                  <button
                    type="button"
                    class="deleteBtn rounded-xl bg-white border border-red-200 px-3 py-2 text-xs font-semibold text-red-700 hover:bg-red-50"
                    data-product-id="{{ product.id }}"
                    data-url="{% url 'delete_product' product.id %}">
                    Delete
                  </button>
                </div>
              </div>
            </div>
          </div>
        {% empty %}
          <div class="px-4 py-12">
            <div class="mx-auto max-w-md text-center">
              <div class="mx-auto h-14 w-14 rounded-2xl bg-gray-100 flex items-center justify-center border border-gray-200">
                <span class="text-gray-500 text-sm">üì¶</span>
              </div>
              <h3 class="mt-4 text-lg font-bold text-gray-900">No products found</h3>
              <p class="mt-1 text-sm text-gray-500">Try changing your filters or add your first product.</p>
              <div class="mt-4">
                <a href="{% url 'add_product' %}" class="inline-flex items-center justify-center rounded-xl bg-black px-4 py-2 text-sm font-semibold text-white hover:bg-gray-900">
                  + Add Product
                </a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      {# Desktop Table (md+) #}
      <div class="hidden md:block overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50 text-gray-600">
            <tr>
              <th class="px-4 py-3 text-left">
                <input id="selectAll" type="checkbox" class="h-4 w-4 rounded border-gray-300" aria-label="Select all on this page">
              </th>
              <th class="px-4 py-3 text-left">Product</th>
              <th class="px-4 py-3 text-left">Price</th>
              <th class="px-4 py-3 text-left">Stock</th>
              <th class="px-4 py-3 text-left">Status</th>
              <th class="px-4 py-3 text-left">Actions</th>
            </tr>
          </thead>

          <tbody class="divide-y divide-gray-100">
            {% for product in products %}
            <tr id="row-{{ product.id }}" class="hover:bg-gray-50">
              <td class="px-4 py-3">
                <input type="checkbox" class="rowCheck h-4 w-4 rounded border-gray-300" value="{{ product.id }}" aria-label="Select product">
              </td>

              <td class="px-4 py-3">
                <div class="flex items-center gap-3">
                  <div class="h-12 w-12 rounded-2xl bg-gray-100 overflow-hidden flex-shrink-0 border border-gray-200">
                    {% with img=product.images.first %}
                      {% if img %}
                        <img src="{{ img.image.url }}" class="h-full w-full object-cover" alt="{{ product.name|escape }}">
                      {% else %}
                        <div class="h-full w-full flex items-center justify-center text-[10px] text-gray-500">No image</div>
                      {% endif %}
                    {% endwith %}
                  </div>

                  <div class="min-w-[240px]">
                    <p class="font-semibold text-gray-900 leading-tight">{{ product.name }}</p>
                    <div class="mt-1 flex flex-wrap items-center gap-2">
                      <span class="text-xs text-gray-500">SKU: {{ product.sku }}</span>
                      {% if product.category %}
                        <span class="text-[11px] rounded-full border border-gray-200 bg-white px-2 py-0.5 text-gray-700">
                          {{ product.category.name }}
                        </span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </td>

              <td class="px-4 py-3 font-semibold text-gray-900">
                {{ currency_symbol }}{{ product.price|floatformat:2|intcomma }}
              </td>

              <td class="px-4 py-3">
                {% if product.stock|default:0 <= 0 %}
                  <span class="inline-flex rounded-full bg-red-100 px-2 py-1 text-xs font-semibold text-red-700">Out</span>
                {% elif product.stock < 5 %}
                  <span class="inline-flex rounded-full bg-amber-100 px-2 py-1 text-xs font-semibold text-amber-700">Low ({{ product.stock }})</span>
                {% else %}
                  <span class="inline-flex rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">{{ product.stock }}</span>
                {% endif %}
              </td>

              <td class="px-4 py-3">
                <button
                  type="button"
                  class="toggleStatus inline-flex items-center gap-2 rounded-xl border border-gray-200 px-3 py-2 text-xs font-semibold bg-white hover:bg-gray-50"
                  data-product-id="{{ product.id }}"
                  data-url="{% url 'toggle_product_status' product.id %}">
                  <span class="statusDot h-2 w-2 rounded-full {% if product.is_active %}bg-emerald-500{% else %}bg-gray-400{% endif %}"></span>
                  <span class="statusLabel">{% if product.is_active %}Active{% else %}Inactive{% endif %}</span>
                </button>
              </td>

              <td class="px-4 py-3">
                <div class="flex flex-wrap gap-2">
                  <a href="{% url 'edit_product' product.id %}"
                     class="rounded-xl bg-black px-3 py-2 text-xs font-semibold text-white hover:bg-gray-900">
                    Edit
                  </a>

                  <a href="{% url 'upload_product_image' product.id %}"
                     class="rounded-xl bg-white border border-gray-200 px-3 py-2 text-xs font-semibold hover:bg-gray-50">
                    Images
                  </a>

                  <button
                    type="button"
                    class="deleteBtn rounded-xl bg-white border border-red-200 px-3 py-2 text-xs font-semibold text-red-700 hover:bg-red-50"
                    data-product-id="{{ product.id }}"
                    data-url="{% url 'delete_product' product.id %}">
                    Delete
                  </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="px-4 py-12">
                <div class="mx-auto max-w-md text-center">
                  <div class="mx-auto h-14 w-14 rounded-2xl bg-gray-100 flex items-center justify-center border border-gray-200">
                    <span class="text-gray-500 text-sm">üì¶</span>
                  </div>
                  <h3 class="mt-4 text-lg font-bold text-gray-900">No products found</h3>
                  <p class="mt-1 text-sm text-gray-500">Try changing your filters or add your first product.</p>
                  <div class="mt-4">
                    <a href="{% url 'add_product' %}" class="inline-flex items-center justify-center rounded-xl bg-black px-4 py-2 text-sm font-semibold text-white hover:bg-gray-900">
                      + Add Product
                    </a>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="px-4 py-4 border-t border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <p class="text-xs text-gray-500">
          Page {{ products.number }} of {{ products.paginator.num_pages }}
        </p>

        <div class="flex flex-wrap gap-2">
          {% if products.has_previous %}
            <a class="rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold hover:bg-gray-50"
               href="?q={{ q|urlencode }}&status={{ status|urlencode }}&stock={{ stock|urlencode }}&sort={{ sort|urlencode }}&page={{ products.previous_page_number }}">
              Prev
            </a>
          {% endif %}

          {% if products.has_next %}
            <a class="rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold hover:bg-gray-50"
               href="?q={{ q|urlencode }}&status={{ status|urlencode }}&stock={{ stock|urlencode }}&sort={{ sort|urlencode }}&page={{ products.next_page_number }}">
              Next
            </a>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // -----------------------------
  // Helpers
  // -----------------------------
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return "";
  }
  const csrftoken = getCookie("csrftoken");

  function isVisible(el) {
    return !!(el && (el.offsetWidth || el.offsetHeight || el.getClientRects().length));
  }
  function visibleChecks() {
    return Array.from(document.querySelectorAll(".rowCheck")).filter(isVisible);
  }
  function selectedIdsVisible() {
    return visibleChecks().filter(cb => cb.checked).map(cb => cb.value);
  }
  function updateSelectedCount() {
    const count = selectedIdsVisible().length;
    const el = document.getElementById("selectedCount");
    if (el) el.textContent = String(count);
  }

  function toast(msg, kind="info") {
    const el = document.getElementById("toast");
    if (!el) return;
    el.textContent = msg;

    el.classList.remove("hidden");
    el.classList.remove("border-emerald-200","border-red-200","border-gray-200","text-emerald-700","text-red-700","text-gray-700","bg-emerald-50","bg-red-50","bg-white");

    if (kind === "success") {
      el.classList.add("border-emerald-200","text-emerald-700","bg-emerald-50");
    } else if (kind === "error") {
      el.classList.add("border-red-200","text-red-700","bg-red-50");
    } else {
      el.classList.add("border-gray-200","text-gray-700","bg-white");
    }

    setTimeout(() => el.classList.add("hidden"), 2200);
  }

  async function fetchJson(url, opts={}) {
    const res = await fetch(url, {
      credentials: "same-origin",
      ...opts,
      headers: {
        "X-CSRFToken": csrftoken,
        "X-Requested-With": "XMLHttpRequest",
        ...(opts.headers || {}),
      },
    });

    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch (_) {}

    if (!res.ok) {
      const msg = (data && (data.error || data.message)) || `Request failed (${res.status})`;
      throw new Error(msg);
    }
    return data;
  }

  function setStatusUI(pid, isActive) {
    document.querySelectorAll(`.toggleStatus[data-product-id="${pid}"]`).forEach(b => {
      const dot = b.querySelector(".statusDot");
      const label = b.querySelector(".statusLabel");
      if (!dot || !label) return;

      dot.classList.remove("bg-emerald-500","bg-gray-400");
      dot.classList.add(isActive ? "bg-emerald-500" : "bg-gray-400");
      label.textContent = isActive ? "Active" : "Inactive";
    });
  }

  // -----------------------------
  // Select all (desktop checkbox)
  // -----------------------------
  const selectAll = document.getElementById("selectAll");
  selectAll?.addEventListener("change", () => {
    visibleChecks().forEach(cb => cb.checked = selectAll.checked);
    updateSelectedCount();
  });

  // Select visible / clear
  document.getElementById("selectAllVisible")?.addEventListener("click", () => {
    visibleChecks().forEach(cb => cb.checked = true);
    if (selectAll) selectAll.checked = true;
    updateSelectedCount();
  });
  document.getElementById("clearVisible")?.addEventListener("click", () => {
    visibleChecks().forEach(cb => cb.checked = false);
    if (selectAll) selectAll.checked = false;
    updateSelectedCount();
  });

  // Update selected counter
  document.addEventListener("change", (e) => {
    if (e.target && e.target.classList && e.target.classList.contains("rowCheck")) {
      updateSelectedCount();
    }
  });
  updateSelectedCount();

  // -----------------------------
  // Event delegation for actions
  // -----------------------------
  const wrap = document.getElementById("productsWrap");

  wrap?.addEventListener("click", async (e) => {
    const t = e.target;
    if (!(t instanceof HTMLElement)) return;

    const toggleBtn = t.closest(".toggleStatus");
    const deleteBtn = t.closest(".deleteBtn");

    // Toggle status
    if (toggleBtn) {
      const url = toggleBtn.getAttribute("data-url");
      const pid = toggleBtn.getAttribute("data-product-id");
      if (!url || !pid) return;

      toggleBtn.setAttribute("disabled", "disabled");
      try {
        const data = await fetchJson(url, { method: "POST" });
        if (!data || data.ok !== true) throw new Error((data && data.error) || "Failed");
        setStatusUI(pid, !!data.is_active);
        toast(`Updated: ${data.is_active ? "Active" : "Inactive"}`, "success");
      } catch (err) {
        toast(err?.message || "Could not update status", "error");
        alert(err?.message || "Could not update status");
      } finally {
        toggleBtn.removeAttribute("disabled");
      }
      return;
    }

    // Delete product
    if (deleteBtn) {
      const url = deleteBtn.getAttribute("data-url");
      const pid = deleteBtn.getAttribute("data-product-id");
      if (!url || !pid) return;

      if (!confirm("Delete this product? This cannot be undone.")) return;

      deleteBtn.setAttribute("disabled", "disabled");
      try {
        const data = await fetchJson(url, { method: "POST" });
        if (!data || data.ok !== true) throw new Error((data && data.error) || "Delete failed");

        document.getElementById(`row-${pid}`)?.remove();
        updateSelectedCount();
        toast("Deleted product", "success");
      } catch (err) {
        toast(err?.message || "Could not delete product", "error");
        alert(err?.message || "Could not delete product");
      } finally {
        deleteBtn.removeAttribute("disabled");
      }
    }
  });

  // -----------------------------
  // Bulk actions
  // -----------------------------
  document.getElementById("runBulk")?.addEventListener("click", async () => {
    const actionEl = document.getElementById("bulkAction");
    const action = actionEl ? actionEl.value : "";
    const ids = selectedIdsVisible();

    if (!action) return alert("Choose a bulk action.");
    if (!ids.length) return alert("Select at least one product.");
    if (action === "delete" && !confirm("Delete selected products? This cannot be undone.")) return;

    const form = new FormData();
    form.append("action", action);
    ids.forEach(id => form.append("ids[]", id));

    const runBtn = document.getElementById("runBulk");
    runBtn?.setAttribute("disabled","disabled");

    try {
      const data = await fetchJson("{% url 'seller_products_bulk_action' %}", {
        method: "POST",
        body: form,
      });
      if (!data || data.ok !== true) throw new Error((data && data.error) || "Bulk action failed");

      if (action === "delete") {
        ids.forEach(id => document.getElementById(`row-${id}`)?.remove());
        if (selectAll) selectAll.checked = false;
        updateSelectedCount();
        toast(`Deleted ${ids.length} item(s)`, "success");
      } else {
        const active = action === "activate";
        ids.forEach(id => setStatusUI(id, active));
        toast("Updated selected items", "success");

        // Uncheck after action
        visibleChecks().forEach(cb => { if (ids.includes(cb.value)) cb.checked = false; });
        if (selectAll) selectAll.checked = false;
        updateSelectedCount();
      }
    } catch (err) {
      toast(err?.message || "Bulk action failed", "error");
      alert(err?.message || "Bulk action failed");
    } finally {
      runBtn?.removeAttribute("disabled");
    }
  });
</script>
{% endblock %}
